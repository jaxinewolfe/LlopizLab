---
title: "ITIS_validation"
author: "Katherine Qi and Jaxine Wolfe"
date: "7/28/2019"
output: html_document
---

namespace_validation: This project uses an R Markdown file (ITIS_validation.Rmd) to resolve and re-classisy given taxonomic groups to the ITIS database (primary) or NCBI (secondary). It generates an output csv file with the original and corrected information that can be manually edited for name space development for further analysis.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(taxize)
# library(worrms)
library(plyr)
library(dplyr)
# library(tcltk)
```

## R Markdown
Set up taxonomy table built from inputted data set 
Run functions first to be able to use them in script (last chunk)- clean up later

Input requirements:
csv table with all species names in a column "name" and their corresponding ids in a column "tsn_id"

```{r}
# local development only
rm(list=ls())

# man.data <- read.csv(file.choose())
# man.data <- read.csv(tk_choose.files(caption = "Choose a .csv file to validate"))

my_path <- "/Users/jaxinewolfe/Documents/Research/PEP/NESLTER/Data/LlopizLab/Abundance/namespace_validation"
setwd(my_path)

```


# helper functions used in script 
```{r}

# wrapper function to call taxize get_wormsid function and put data into appropriate column
acquire_id <- function(resolved_name, counter, man.data) {
  response <- taxize::get_tsn(
    resolved_name,
    searchtype = 'scientific',
    accepted = TRUE,
    ask = FALSE,
    messages = FALSE
  )
  # check if name was able to return an id from itis
  response <- as.data.frame(response)
  if (!empty(response)) {
    # standardize resolved name to retrieve id
    resolved_name <- gsub(" ", ".", resolved_name, fixed=TRUE)
    resolved_name <- gsub("-", ".", resolved_name, fixed=TRUE)
    # get.id <- paste(resolved_name, sep='.', "ids") #?
    # Pull highest order taxon id
    resolved_id <- response$ids
    man.data$resolved_id_fromgnr[counter] <<- resolved_id
    # sets data_source column if original name could not be resolved through gnr 
    man.data$data_source[counter] <<- "ITIS"
  } # else leaves columns with original NA values
}


# retrieves taxon information based on name
name2taxoninfo <- function(tx_name, counter, man.data) {
  # use itis db to get taxon level
  taxon_level <- unlist(tax_rank(tx_name, db='itis', rows=1))
  man.data$resolved_taxon_level_fromgnr[counter] <<- taxon_level
  # use taxize classification function to get higher order (class, infraphylum, phylum)
  hierarchy <- taxize::classification(tx_name, db='itis', rows=1)
  # get class, infraphylum, and phylum
  hierarchy <- as.data.frame(hierarchy[[1]])
  genus <- hierarchy$name[hierarchy$rank == "genus"]
  order <- hierarchy$name[hierarchy$rank == "order"]
  class <- hierarchy$name[hierarchy$rank == "class"]
  phylum <- hierarchy$name[hierarchy$rank == "phylum"]
  
  # check which of the main groups tx_name falls under and assign bins
  if (!identical(character(0), class) && class == "Appendicularia") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Appendicularian"
  } else if (!identical(character(0), order) && order == "Amphipoda") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Amphipod"
  } else if (!identical(character(0), order) && order == "Euphausiacea") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Krill"
  } else if (!identical(character(0), phylum) && phylum == "Chaetognatha") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Chaetognath"
  } else if (!identical(character(0), order) && order == "Calanoida") {
      if (!identical(character(0), genus) && genus == "Centropages") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Centropages"
      } else if (!identical(character(0), genus) && genus == "Calanus") {
       man.data$resolved_higher_order_fromgnr[counter] <<- "Calanus"
      } else {
        man.data$resolved_higher_order_fromgnr[counter] <<- "Other Calanoids"
      }
  } else {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Other"
    }
}


# retrieves taxon info based on id: level, name, and higher order 
id2taxoninfo <- function(tsn, counter, man.data) {
  # populate taxon_level 
  taxon_level <- unlist(id2name(tsn, db = 'itis')[[1]]$rank)
  # alt option: unlist(tax_rank(tsn, db='itis', rows=1))
  man.data$taxon_level_fromid[counter] <<- taxon_level
  # populate taxon_name
  taxon_name <- unlist(id2name(tsn, db = 'itis')[[1]]$name)
  man.data$taxon_name_fromid[counter] <<- taxon_name
  # populate higher_order
  hierarchy <- as.data.frame(classification(tsn, db='itis', rows=1)[[1]])
  # only set resolved id in the case that the resolved id doesn't exist yet
  # if (is.na(man.data$resolved_higher_order_fromgnr[counter])) {
  #   taxon_level <- tools::toTitleCase(taxon_level)
  #   man.data$resolved_id_fromgnr[counter] <<- hierarchy$id[hierarchy$rank == taxon_level]
  # }
  # get genus, order,class, and phylum
  genus <- hierarchy$name[hierarchy$rank == "genus"]
  order <- hierarchy$name[hierarchy$rank == "order"]
  class <- hierarchy$name[hierarchy$rank == "class"]
  phylum <- hierarchy$name[hierarchy$rank == "phylum"]
  
  # check which of the main groups tx_name falls under and assign bins
  if (!identical(character(0), class) && class == "Appendicularia") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Appendicularian"
  } else if (!identical(character(0), order) && order == "Amphipoda") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Amphipod"
  } else if (!identical(character(0), order) && order == "Euphausiacea") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Krill"
  } else if (!identical(character(0), phylum) && phylum == "Chaetognatha") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Chaetognath"
  } else if (!identical(character(0), order) && order == "Calanoida") {
      if (!identical(character(0), genus) && genus == "Centropages") {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Centropages"
      } else if (!identical(character(0), genus) && genus == "Calanus") {
       man.data$resolved_higher_order_fromgnr[counter] <<- "Calanus"
      } else {
        man.data$resolved_higher_order_fromgnr[counter] <<- "Other Calanoids"
      }
  } else {
      man.data$resolved_higher_order_fromgnr[counter] <<- "Other"
    }
  
  # sets data_source column if original name could not be resolved through gnr 
  # man.data$data_source[counter] <<- "World Register of Marine Species"
  man.data$data_source[counter] <<- "ITIS"
}

# helper function to fill in information for abiotic classes
edge_case <- function(name, counter) {
  if(name == "PPC" | name == "Fish Remains"|
     name == "Other"| name == "Unknown" | 
     name == "Parasite" | is.na(name)) {
    man.data$alt_datasource[counter] <<- "OCB"
    man.data$alt_resolved_name[counter] <<- toString(name)
    return(TRUE)
  }
  return(FALSE)
}

```

## Script for using taxize package
```{r, echo=FALSE, include=FALSE}

# manually added a preytype_validated column for ease of GNR
preytype_lookup <- read_csv("Llopiz_preytypes.csv")
# set preytype validated column as man.data
man.data <- preytype_lookup %>% select(preytype_validated)

# Resolve names 
counter <- 1
# column names 
man.data$tsn_id <- NA_character_
man.data$resolved_names <- NA_character_
man.data$taxon_level_fromid <- NA_character_
man.data$taxon_name_fromid <- NA_character_
man.data$higher_order_fromid <- NA_character_
man.data$data_source <- NA_character_
man.data$resolved_id_fromgnr <- NA_character_
man.data$resolved_taxon_level_fromgnr <- NA_character_
man.data$resolved_higher_order_fromgnr <- NA_character_
man.data$name_match <- FALSE
man.data$id_match <- FALSE
man.data$higher_match <- FALSE
man.data$alt_datasource <- NA_character_
man.data$alt_resolved_name <- NA_character_

# reorder columns
man.data[,c("preytype_validated", "tsn_id", "resolved_names", "taxon_level_fromid", "taxon_name_fromid", "higher_order_fromid", "data_source", "resolved_id_fromgnr", "resolved_taxon_level_fromgnr", "resolved_higher_order_fromgnr", "name_match", "id_match", "higher_match", "alt_datasource", "alt_resolved_name")] 

# loop through all rows
for (row in 1:nrow(man.data)) {
  # first check if name is abiotic
  if (edge_case(man.data$preytype_validated[counter], counter)) {
    # skip to next row if true
    counter <- counter + 1
    next
  }
  # try to resolve the name with gnr
  temp <- gnr_resolve(names = as.vector(man.data$preytype_validated[counter]), 
                      canonical = T, best_match_only = T, 
                      preferred_data_sources = c(3, 4)) 
  # 9 = worms
  # 4 = ncbi
  # 3 = itis
  # hardcoded from data sources: https://resolver.globalnames.org/data_sources
  
  # set primary data source
  # primary_ds <- "World Register of Marine Species"
  primary_ds <- "ITIS"
  # check if able to resolve name 
  if (!empty(temp)) {
    # add to resolved_names column
    resolved_name <- unlist(temp[1, 'matched_name2'])
    man.data$resolved_names[counter] <- resolved_name
    # add to data_source or alt_ds column
    authority <- unlist(temp[1, 'data_source_title'])
    # add to data_source if ITIS or alt_ds for other 
    if (authority == primary_ds) {
      man.data$data_source[counter] <- authority
    } else {
      man.data$alt_datasource[counter] <- authority
      man.data$alt_resolved_name[counter] <- resolved_name
    }
    
    # edge case: check if tsn_id does not exist in input file() taxon_level, name, higher order are false)
    if (man.data$tsn_id[counter] == -999 | is.na(man.data$tsn_id[counter])) {
      # call helper function to retrieve ID from resolved name 
      acquire_id(resolved_name, counter, man.data)
      # retrieve taxon level from resolved_name
      name2taxoninfo(resolved_name, counter, man.data)
      # higher_match, id_match, and name_match remain false as original ID did not exist
    } 
    # else tsn_id does exist in input file
    else {
      # set resolved_id from resolved_name
      acquire_id(resolved_name, counter, man.data)
      # call helper function to retrieve taxon info from id
      id2taxoninfo(man.data$tsn_id[counter], counter, man.data)
      # call helper function to retrieve taxon info from resolved_name 
      name2taxoninfo(resolved_name, counter, man.data)
      
      # check if taxon name matches with resolved
      if (man.data$taxon_name_fromid[counter] == man.data$resolved_names[counter]) {
        # set name_match to true
        man.data$name_match[counter] <- TRUE
      }
      # check if id matches with resolved
      if (man.data$tsn_id[counter] == man.data$resolved_id_fromgnr[counter]) {
        # set id_match to true
        man.data$id_match[counter] <- TRUE
      }
      # check if higher order matches with resolved
      if (man.data$higher_order_fromid[counter] == man.data$resolved_higher_order_fromgnr[counter]) {
        man.data$higher_match[counter] <- TRUE
      }
    }
  } else {
    # case: gnr unable to resolve by name, fill with NA 
    man.data$resolved_names[counter] <- NA_character_

    # edge case: check if tsn_id is not empty for row 
    if(!is.na(man.data$tsn_id[counter])) {
      # fill in taxon info based on ID
      id <- man.data$tsn_id[counter]
      id2taxoninfo(id, counter, man.data)
      # leave resolved information as NA and check match columns false
    }
    # edge case: unable to resolve name and tsn_id does not exist 
    else {
      # check if id can be resolved with original, unresolved name
      test_name <- man.data$preytype_validated[counter]
      acquire_id(test_name, counter, man.data)
      
      # see if id was able to be resolved
      if (!is.na(man.data$resolved_id_fromgnr[counter])) {
        # fill in taxon info from id
        id2taxoninfo(man.data$resolved_id_fromgnr[counter], counter, man.data)
        # leave resolved information as NA and check match columns false
      }
      # unable to get id from original name 
      else {
        # fill ID with NA
        man.data$resolved_id_fromgnr[counter] <- NA_character_
      }
    }
  }
  counter <- counter + 1
}

# collect all names with no resolved id
# sosik_specific <- man.data$preytype_validated[is.na(man.data$resolved_id_fromgnr)]
# worms_verified <- man.data$preytype_validated[!is.na(man.data$resolved_id_fromgnr)]

# convert to csv file 
# write.csv(man.data, my_path)

```